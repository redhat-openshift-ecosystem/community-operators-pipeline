# Framework Overview

## TODO

- diagram
## Introduction

The goal of [the community operator pipeline framework project](https://github.com/redhat-openshift-ecosystem/community-operators-pipeline) is to deploy and configure pipelines for various flavors of Kubernetes or Openshift clusters and publish multiple versions of operator indexes.
GitHub projects via GitHub Action technology are supported. Currently, the following projects are supported:


## Codebase and development
| Name | Project| Barnches |
|------|--------|---------------|
|Framework|[https://github.com/redhat-openshift-ecosystem/community-operators-pipeline](https://github.com/redhat-openshift-ecosystem/community-operators-pipeline)|`ci/latest` and `ci/dev`|
|Ansible playbooks|[https://github.com/redhat-openshift-ecosystem/operator-test-playbooks](https://github.com/redhat-openshift-ecosystem/operator-test-playbooks)|`upstream-community` and `upstream-community-dev`|
|User and maintainer documentation ([k8s](https://k8s-operatorhub.github.io/community-operators/) and [ocp](https://redhat-openshift-ecosystem.github.io/community-operators-prod/))|[https://github.com/redhat-openshift-ecosystem/community-operators-pipeline](https://github.com/redhat-openshift-ecosystem/community-operators-pipeline)|`documentation`|
|[Admin Documentation](https://redhat-openshift-ecosystem.github.io/community-operators-pipeline/)|[https://github.com/redhat-openshift-ecosystem/community-operators-pipeline](https://github.com/redhat-openshift-ecosystem/community-operators-pipeline)|`documentation-admin`|


## Producion operator repositories
| Name | Project| Configuration |
|------|--------|---------------|
|Kubernetes operators ([OperatorHub.io](https://operatorhub.io/))|[https://github.com/k8s-operatorhub/community-operators](https://github.com/k8s-operatorhub/community-operators)|[pipeline-config.yaml](https://github.com/k8s-operatorhub/community-operators/blob/main/ci/pipeline-config-k8s.yaml)|
|OpenShift ([OCP](https://www.redhat.com/en/technologies/cloud-computing/openshift)) operators|[https://github.com/redhat-openshift-ecosystem/community-operators-prod](https://github.com/redhat-openshift-ecosystem/community-operators-prod)|[pipeline-config.yaml](https://github.com/redhat-openshift-ecosystem/community-operators-prod/blob/main/ci/pipeline-config-ocp.yaml)|
|Staging environment|[https://github.com/redhat-openshift-ecosystem/community-operators-pipeline](https://github.com/redhat-openshift-ecosystem/community-operators-pipeline)|[pipeline-config-k8s.yaml](https://github.com/redhat-openshift-ecosystem/community-operators-prod/blob/main/ci/pipeline-config-k8s.yaml) and [pipeline-config-ocp.yaml](https://github.com/redhat-openshift-ecosystem/community-operators-prod/blob/main/ci/pipeline-config-ocp.yaml)|

### Project structure
Each project should contain the following directory structure
```
$ tree -L 1 --sort=mtime -a
.
├── LICENSE
├── .github
├── categories.json
├── upstream.Dockerfile
├── scripts
├── .gitignore
├── docs
├── README.md
├── config.yaml
├── ci
├── operators
└── .git
```
The following table is describing each file or directory

| File | Description |
|------|--------|
|`README.md`|Main README file|
|`ci/`|Project CI configration directory|
|`operators/`|Directory contains all operators with the versions|
|`categories.json`|Config file with list of categories|
|`config.yaml`|Operator pipelines config file|
|`docs/`|Contains file with pull request predefined template (generated by the framework. Don't change!!!)|
|`.github/workflows`|Directory contains GitHub Action workflows (generated by the framework. Don't change!!!)|
|`upstream.Dockerfile`|Dockerfile needed for CI pipeline (generated by the framework. Don't change!!!)|
|`scripts/`|Temporary scripts directory (generated by the framework. Don't change!!!)|


### Testing Pipeline

The testing pipeline is shown below

```mermaid
flowchart TD
    A0[PR]
    A0 --> |push| B0(Operator test)
    A0 --> |push| C0(Operator CI)
    A0 --> |labeled| D0(Operator CI Labels)
    A0 --> |push| E0(DCO test)
    A0 --> |comment| F0[&#47retest]
    A0 --> |comment| G0[&#47merge possible]
    B0 --> |job|B10[lemon]
    B0 --> |job|B11[orange]
    B0 --> |job|B12[kiwi]
    E0 --> E1(DCO Workflow Complete)
    F0 --> F1(Issue Comments - retest)
    G0 --> G1(Issue Comments - merge)
    B10 --> B2(Operator Workflow Complete)
    B11 --> B2
    B12 --> B2
    B2 --> |handle label|B3[package-validated]
    B3 --> |handle label|B4[installation-validated]
    B4 --> |make comment|B5[&#47merge possible]
    C0 --> |job|C1[operator-automerge-enabled]
    C1 --> |handled label|C2[automerge-disabled]
    C2 --> |job|C20[operator-ci]
    C20 --> |handle label|C21[new-operator]
    C20 --> |handle label|C22[allow/operator-version-overwrite]
    C20 --> |handle label|C23[allow/operator-recreate]
    C20 --> |on error|C24[Fail + PR comment]
    D0 --> |handle label|D1[authorized-changes]
    D1 --> |make comment|G0
    G1 --> G2[automerge]
    F1 --> |make comment|F20[&#47hold]
    F1 --> |make comment|F21[&#47hold cancel]
    E1 --> |handle label|E2[dco-failed]
```
 [Download or edit](https://mermaid.live/edit#pako:eNqFlGFvmzAQhv-KxaQp04oGJNOkfJg0IESVJrVqJ00a6QcHX4IXYyPbNNpK__tMMAlpnZVPNve8vvfuDE9eIQh4c2_DxL4osdToR7riyDzfgvz27mFYI9__itq6UWWL4mByU4PEWkikQekPLigZQcn1C4ThNTAgLUrPKPS9e6-c5y2CSZrcuPIVoqqA6xZlQf7-3eyLhA56uAAte6gCuQVUC6XomoGFYwv_Fus2DoOcQSW4MxbmQmK-dQujfEf31IYWfWgRHuz_FHLXtRoloqqZMWpryXoqCyfXSjXQhTu7CvmoL8dyy55bOrhDRRYz5g9cHJ3aeym1Kcaywz463_fbtsScMECH0bXxNK9xscNb8B8xowRrIEMvpi5-llOuNGYMayr4a9GsF1V4B2iYVfz58qiSUccTMw1bpY8bLQ4CHzg2-JAgCceuiLWVRPlJQKg6U0SjDFFwSlHQIxE4Sk2iMOew9wf-Ddg4YGYqn47HP4JUXYuEWewl1fDGAdOXB0goJODXOsERSCmk0czyDFOGPqLbu6Hblk5dSdKwa1MpJP0LxDe_CXPz1SAIHZNbBva69sHlqM1WlrlkWdR_nKVg5P9ceORQgXkBbPjaQof9RZSTQvgbU7KZrnflGSMVpsT89p462crTJVSw8uZmSWCDG6ZX3oo_G7Spu2u6INR01ptvMFNw5XXF3P_hhTfXsoEBSineSlwdqRrzX0IM--d_jDez4w){:target="_blank"}

### Release Pipeline

The release pipeline is shown below
```mermaid
 flowchart LR
    A0(PR-traffic-light)
    A0 --> A1(Remove Operator)
    A1 --> A2(Index check)
    A2 --> A3(Bundles)
    A3 --> A4(Index)
    A4 --> A5(Index verify)
    A5 --> A6(Slack notification)
```
 [Download or edit](https://mermaid.live/edit#pako:eNo9j8tqAzEMRX_FaDWFDDSvLmZRSGkXhULLZFe8EbacMfFjcOS0IeTf6-K6Wkn3XAndK6ioCQYwLn6pCROLt1EGUWp3332MPSc0xqre2cPEd42Ivn8Uu2U3ko9nEu8zJeSYGl9Wvupeg6ZvoSZSx8ZWla27pxy0o1PT11Xf1J2mbqq6_bt0pmTNpcFthQ_d3qE6ihDZlleRbQzFAgvwlDxaXeJdf1ck8ESeJAyl1WQwO5Ygw61Y86yR6UXbEgMGg-5EC8DMcX8JCgZOmZrp2eIhof93zRg-Y2zz7QfnHGgI){:target="_blank"}

The release pipeline for `k8s` with publishing index into [operatorhub.io](https://operatorhub.io/) is shown below

```mermaid
flowchart LR
    A0(PR-traffic-light)
    A0 --> A1(Remove Operator)
    A1 --> A2(Index check)
    A2 --> A3(Bundles)
    A3 --> A4(Index)
    A4 --> A50(OHIO image)
    A4 --> A51(Index verify)
    A50 --> A6(Release / operatorhub.io)
    A6 --> A7(Slack notification)
    A51 --> A7
```
 [Download or edit](https://mermaid.live/edit#pako:eNpdkM1qwzAQhF9F6KRC3Mb5BR8KKS00UHBxbsWXrbSyRWTJyFLaEPLuVbGVQ3RazTfandWFciuQFlRq-8NbcJ58VLUh8ezm7LPKvAMpFc-0alr_kAjJsmeyy1mFnT0hKXt04K1LPB_5gu2NwF_CW-THxBYjW7KXYITGIenLUV-Nb5K6GtX1nJXv-5KoDhq8Z_k05oROyXOi6ynkJobUCAOSJ2KnnG34flQ2OTejccsOGviRGOtV3Bi8subWbNpoS2e0Q9eBEvHPLv-0pr7FDmtaxFKghKB9TWtzjdbQC_D4JlScSQsJesAZheDt4Ww4LbwLmEyvChoH3c3Vg_myNt2vfzEqfgM){:target="_blank"}



